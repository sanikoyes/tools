Import('env')

env_lib = env.Clone()


FLAGS = [
	'-DHAVE_INTTYPES_H',
	'-DHAVE__BOOL',
	'-DHAVE_SMALL',
	'-DLZMA_API_STATIC',
	'-I3rd/zlib',
	'-Isource/lua-ziparchive/Misc/liblzma/common',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/api',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/api',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/check',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/common',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/delta',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/lz',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/lzma',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/rangecoder',
	'-Isource/lua-ziparchive/Misc/liblzma/liblzma/simple',
]

import sys
if sys.platform in ['win32']:
	FLAGS.append('-DLUA_BUILD_AS_DLL')
else:
	FLAGS.append('-std=c99')
	FLAGS.append('-DHAVE_CONFIG_H')

env_lib.Append(CFLAGS=FLAGS)
env_lib.Append(CPPFLAGS=FLAGS)

lib_sources = [
	"Misc/AnsiString.cpp",
	"Misc/DiskFile.cpp",
	"Misc/HeapString.cpp",
	"Misc/MemFile.cpp",
	"Misc/Misc.cpp",
	"Misc/Misc_InternalPch.cpp",
	"Misc/ZipArchive.cpp",
	# "Misc/ZipArchiveManager.cpp",
	"Misc/ZipEntryFile.cpp",
	"Misc/aes/aescrypt.c",
	"Misc/aes/aeskey.c",
	"Misc/aes/aestab.c",
	# "Misc/aes/aesxam.c",
	"Misc/aes/aes_modes.c",
	"Misc/aes/fileenc.c",
	"Misc/aes/hmac.c",
	"Misc/aes/prng.c",
	"Misc/aes/pwd2key.c",
	"Misc/aes/sha1.c",
	"Misc/aes/sha2.c",
	# "Misc/liblzma/common/tuklib_cpucores.c",
	# "Misc/liblzma/common/tuklib_exit.c",
	# "Misc/liblzma/common/tuklib_mbstr_fw.c",
	# "Misc/liblzma/common/tuklib_mbstr_width.c",
	# "Misc/liblzma/common/tuklib_open_stdxxx.c",
	"Misc/liblzma/common/tuklib_physmem.c",
	# "Misc/liblzma/common/tuklib_progname.c",
	# "Misc/liblzma/liblzma/check/check.c",
	# "Misc/liblzma/liblzma/check/crc32_fast.c",
	"Misc/liblzma/liblzma/check/crc32_small.c",
	# "Misc/liblzma/liblzma/check/crc32_table.c",
	# "Misc/liblzma/liblzma/check/crc32_tablegen.c",
	# "Misc/liblzma/liblzma/check/crc64_fast.c",
	# "Misc/liblzma/liblzma/check/crc64_small.c",
	# "Misc/liblzma/liblzma/check/crc64_table.c",
	# "Misc/liblzma/liblzma/check/crc64_tablegen.c",
	# "Misc/liblzma/liblzma/check/sha256.c",
	"Misc/liblzma/liblzma/common/alone_decoder.c",
	"Misc/liblzma/liblzma/common/alone_encoder.c",
	"Misc/liblzma/liblzma/common/alone_zip_decoder.c",
	"Misc/liblzma/liblzma/common/alone_zip_encoder.c",
	# "Misc/liblzma/liblzma/common/auto_decoder.c",
	# "Misc/liblzma/liblzma/common/block_buffer_decoder.c",
	# "Misc/liblzma/liblzma/common/block_buffer_encoder.c",
	# "Misc/liblzma/liblzma/common/block_decoder.c",
	# "Misc/liblzma/liblzma/common/block_encoder.c",
	# "Misc/liblzma/liblzma/common/block_header_decoder.c",
	# "Misc/liblzma/liblzma/common/block_header_encoder.c",
	# "Misc/liblzma/liblzma/common/block_util.c",
	"Misc/liblzma/liblzma/common/common.c",
	# "Misc/liblzma/liblzma/common/easy_buffer_encoder.c",
	# "Misc/liblzma/liblzma/common/easy_decoder_memusage.c",
	# "Misc/liblzma/liblzma/common/easy_encoder.c",
	# "Misc/liblzma/liblzma/common/easy_encoder_memusage.c",
	# "Misc/liblzma/liblzma/common/easy_preset.c",
	# "Misc/liblzma/liblzma/common/filter_buffer_decoder.c",
	# "Misc/liblzma/liblzma/common/filter_buffer_encoder.c",
	# "Misc/liblzma/liblzma/common/filter_common.c",
	# "Misc/liblzma/liblzma/common/filter_decoder.c",
	# "Misc/liblzma/liblzma/common/filter_encoder.c",
	# "Misc/liblzma/liblzma/common/filter_flags_decoder.c",
	# "Misc/liblzma/liblzma/common/filter_flags_encoder.c",
	# "Misc/liblzma/liblzma/common/hardware_cputhreads.c",
	# "Misc/liblzma/liblzma/common/hardware_physmem.c",
	# "Misc/liblzma/liblzma/common/index.c",
	# "Misc/liblzma/liblzma/common/index_decoder.c",
	# "Misc/liblzma/liblzma/common/index_encoder.c",
	# "Misc/liblzma/liblzma/common/index_hash.c",
	# "Misc/liblzma/liblzma/common/outqueue.c",
	# "Misc/liblzma/liblzma/common/stream_buffer_decoder.c",
	# "Misc/liblzma/liblzma/common/stream_buffer_encoder.c",
	# "Misc/liblzma/liblzma/common/stream_decoder.c",
	# "Misc/liblzma/liblzma/common/stream_encoder.c",
	# "Misc/liblzma/liblzma/common/stream_encoder_mt.c",
	# "Misc/liblzma/liblzma/common/stream_flags_common.c",
	# "Misc/liblzma/liblzma/common/stream_flags_decoder.c",
	# "Misc/liblzma/liblzma/common/stream_flags_encoder.c",
	# "Misc/liblzma/liblzma/common/vli_decoder.c",
	# "Misc/liblzma/liblzma/common/vli_encoder.c",
	# "Misc/liblzma/liblzma/common/vli_size.c",
	# "Misc/liblzma/liblzma/delta/delta_common.c",
	# "Misc/liblzma/liblzma/delta/delta_decoder.c",
	# "Misc/liblzma/liblzma/delta/delta_encoder.c",
	"Misc/liblzma/liblzma/lz/lz_decoder.c",
	"Misc/liblzma/liblzma/lz/lz_encoder.c",
	"Misc/liblzma/liblzma/lz/lz_encoder_mf.c",
	# "Misc/liblzma/liblzma/lzma/fastpos_table.c",
	# "Misc/liblzma/liblzma/lzma/fastpos_tablegen.c",
	# "Misc/liblzma/liblzma/lzma/lzma2_decoder.c",
	"Misc/liblzma/liblzma/lzma/lzma2_encoder.c",
	"Misc/liblzma/liblzma/lzma/lzma_decoder.c",
	"Misc/liblzma/liblzma/lzma/lzma_encoder.c",
	"Misc/liblzma/liblzma/lzma/lzma_encoder_optimum_fast.c",
	"Misc/liblzma/liblzma/lzma/lzma_encoder_optimum_normal.c",
	"Misc/liblzma/liblzma/lzma/lzma_encoder_presets.c",
	"Misc/liblzma/liblzma/rangecoder/price_table.c",
	# "Misc/liblzma/liblzma/rangecoder/price_tablegen.c",
	# "Misc/liblzma/liblzma/simple/arm.c",
	# "Misc/liblzma/liblzma/simple/armthumb.c",
	# "Misc/liblzma/liblzma/simple/ia64.c",
	# "Misc/liblzma/liblzma/simple/powerpc.c",
	# "Misc/liblzma/liblzma/simple/simple_coder.c",
	# "Misc/liblzma/liblzma/simple/simple_decoder.c",
	# "Misc/liblzma/liblzma/simple/simple_encoder.c",
	# "Misc/liblzma/liblzma/simple/sparc.c",
	# "Misc/liblzma/liblzma/simple/x86.c",
	"Misc/lzma/LzFind.c",
	"Misc/lzma/LzFindMt.c",
	"Misc/lzma/Lzma2Dec.c",
	"Misc/lzma/Lzma2Enc.c",
	"Misc/lzma/LzmaDec.c",
	"Misc/lzma/LzmaEnc.c",
	"Misc/lzma/MtCoder.c",
	"Misc/lzma/Threads.c",
	"Misc/md5/md5c.c",
	"Misc/trio/trio.c",
	"Misc/trio/trionan.c",
	"Misc/trio/triostr.c",
	"lziparchive.cpp",
]

env_lib.Prepend(LIBS=["zlib1"])
env_lib.SharedLibrary("#bin/ziparchive", lib_sources)
